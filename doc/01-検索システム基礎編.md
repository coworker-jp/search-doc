# 検索システム基礎編

+ **対象者:** 全文検索システムを知らない人
+ **ゴール:** 全文検索システムを導入できる
+ **内容:** 検索システムを構築しながら、検索システムの使い方や使い所を学ぶ

+ **必須スキル**
  + 基礎的なプログラミング能力
+ **推奨スキル**
  + Pythonの知識

---

## 1-1 検索システムとは
検索キーワードにあった文章などを見つけるためのソフトウェアを、検索システムといいます。
現在では、様々な検索システムのサービスが存在しており、
大きなWebサービスではたいていの場合、キーワードによる検索でコンテンツを探し出すことができます。

例えば、Eコマースのウェブサービスを例に考えてみましょう。
大きなショッピングサービスでは、数百万から数千万以上の商品が存在しており、
人間が人力で欲しい商品を探し出すのは非常に困難です。

検索システムは人間が膨大なデータの中から、欲しい情報を探し出すのを補助してくれるツールと言えます。
この検索システム講座では、検索システムを構築しながら、原理や使い方を解説します。

## 1-2 全文検索とは
複数文書の集合から、ある検索ワードにマッチする文書を探すことを全文検索といいます。
全文検索を行うには、大きく分けて以下の二つがあります。

+ 逐次検索
+ インデックスを用いた検索

逐次検索は文書の全体を順番にみていく方法で、文書の数に比例して探すだす時間が増えていきます。
UNIXコマンドのgrepなど逐次検索の例と言えます。

一方インデックスを用いた検索では、文書の数が増えたとしても、文書全体を毎回走査しているわけではないため、
探し出すのにかかる時間はそこまで大きくならないです。
Googleのような検索サービスが、検索ワードにマッチするWebサイトを返却する速度が高速なのはこのためです。

例えば、分厚い本から、ある単語が出現するページを探すのは難しいことですが、
索引を利用すると、何ページにその検索ワードが出現するのか簡単にわかります。

逐次検索は、高速な検索を行う事は難しいですが、事前にインデックスを構築する必要がないため、
文書の数が少ない場合は向いています。
一方、インデックスを用いた検索ではインデックス構築の手間がありますが、高速な検索が可能です。

今回の講義では、様々な検索システムの基本的なアイデアとなっている、インデックスについて説明します。

## 1-3 転置インデックス
検索システムに利用されるインデックスの中で、最も一般的な物に転置インデックスがあります。
転置インデックスは、その単語がどの文書に含まれるのかをデータベースに記録したものです。
例えば、以下のような文書集合があったとします。

* 文書1: ノーム・チョムスキーとは、アメリカの学者である
* 文書2: アルベルト・アインシュタインとは、ドイツの学者である
* 文書3: グラハム・ベルとは、スコットランドの発明家である。

日本語の文章の転置インデックスを構築するには、まず最初に形態素解析を行いキーワードを区切ってあげる必要があります。

形態素解析を通した後の文書

| 文書番号 | 文章 | 
|:---|:---|
| 文書1 | ノーム・チョムスキー/とは/アメリカ/の/学者/である | 
| 文書2 | アルベルト・アインシュタイン/とは、/ドイツ/の/学者/である/ |
| 文書3 | /グラハム・ベル/とは/スコットランド/の/発明家/である/ |

検索に利用しない助詞などを取り除くと以下のようになります。

| 文書番号 | 文章 | 
|:---|:---|
| 文書1 | ノーム・チョムスキー/アメリカ/学者/ |
| 文書2 | アルベルト・アインシュタイン/ドイツ/学者/ |
| 文書3 | /グラハム・ベル/スコットランド/発明家/ |

上記の情報を利用して、転置インデックスを構築すると以下のようになります。

|キーワード | 文書番号 |
|:---|:---|
| ノーム・チョムスキー | 文書1 |
| アメリカ | 文書1 |
| 学者 | 文書1, 文書2 |
| アルベルト・アインシュタイン| 文書2 |
| ドイツ | 文書2 | 
| グラハム・ベル | 文書3 |
| スコットランド | 文書3 |
| 発明家 | 文書3 |

例えば、以下の文章を検索システムに問い合わせることを考えてみましょう。
検索システムに問い合わせるキーワードのことを、「検索クエリ」と呼びます。

> チョムスキーって誰だっけ？

このクエリを、インデックスと同じように形態素解析してあげます。

* チョムスキー
* 誰

上記の転置インデックス表から、この2つのうちどちらかが含まれているのは、文書1ということがわかります。


## 1-5 簡単な検索システムの実装 
検索システムを理解するために、簡単な検索システムを作ってみましょう。
環境構築を行っていない場合は、[環境構築](./00-環境構築.md) を参考にして、Pythonインストールを行ってください。

ここでは、

## 形態素解析
まず検索インデックスを作るには、日本語の文書を形態素解析する必要があります。
ここでは、Pythonで簡単に使える[Janome](https://mocobeta.github.io/janome/)を利用します。

Janomeで形態素解析を行うにはは、以下のようにします。
```
from janome.tokenizer import Tokenizer
tokenizer = Tokenizer()
for token in tokenizer.tokenize("チョムスキーって誰だっけ？"):
    print(token)
```

出力結果は以下のようになります。
```
チョムスキー    名詞,固有名詞,人名,姓,*,*,チョムスキー,チョムスキー,チョムスキー
って    助詞,格助詞,連語,*,*,*,って,ッテ,ッテ
誰      名詞,代名詞,一般,*,*,*,誰,ダレ,ダレ
だ      助動詞,*,*,*,特殊・ダ,基本形,だ,ダ,ダ
っけ    助詞,終助詞,*,*,*,*,っけ,ッケ,ッケ
？      記号,一般,*,*,*,*,？,？,？
```

単語の品詞の情報を取得するには、token.part_of_speechを用います。
これを利用して、品詞のフィルタなどに利用できます。
```
for token in tokenizer.tokenize("チョムスキーって誰だっけ？"):
    print(token.part_of_speech)
```

## 演習問題
説明した内容を用いて、転置インデックスを利用した検索スクリプトを完成させてみましょう。
ex01.pyに以下の空の関数があります。それぞれ以下の機能を持ちます。

- tokenize: 文章を形態素解析して、名詞のみの単語リストを返す
- make_index: 文書の集合から、転置インデックスを作成する
- test_search: 実際の検索機能

test_ex01.pyはそれぞれの関数の単体テストとなっており、
pytestによって、期待する動作が記述されているかチェックすることができます。

```
$ py.test src/test_ex01.py
```

## 問題1 形態素解析器の作成
名詞のみの単語リストを返す、関数tokenizeを完成させてください。

tokenizeは文字列を受け取り、それを分割してリストで返却します。
```
def tokenize(document: str) -> List[str]:
```

### ヒント 
- 品詞の判定は, token.part_of_speechで行うことができます
- 文字列メソッドstartswithを利用すると実装が楽です
- tokenオブジェクトのsurfaceメソッドでトークンの文字列を取得できます


## 問題2 転置インデックスの作成
転置インデックスを作成する、関数make_indexを完成させてください。
make_indexは文書ID、文章の組みのdictから、インデックス（単語、文書IDのリスト）を返却します。
```
def make_index(documents: Dict[str, str]) -> Dict[str, list]:
```

## 問題3 検索機能の実装
インデックスを利用して検索を行う、関数searchを完成させてください。
形態素解析後で得られた、分割されたクエリが含まれる全ての文書IDの集合を返却するようにしてください。
```
def search(index: Dict[str, str], query: str) -> Set[str]:
```

